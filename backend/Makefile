# uv é»˜è®¤ä½¿ç”¨ .venvï¼Œé€‚åˆæœ¬åœ°å¼€å‘
VENV := .venv
UV := uv

.DEFAULT_GOAL := init

.PHONY: help
help: ## æ‰“å°å¸¸ç”¨å‘½ä»¤è¯´æ˜
	@echo "å¯ç”¨å‘½ä»¤:"; \
	awk 'BEGIN {FS=":.*##"} /^[a-zA-Z0-9_.-]+:.*##/ {gsub(/^ +| $$/, "", $$2); printf "  %-18s %s\n", $$1, $$2}' $(MAKEFILE_LIST)

init: venv install env ## åˆå§‹åŒ–é¡¹ç›®ï¼šåˆ›å»ºè™šæ‹Ÿç¯å¢ƒ + å®‰è£…ä¾èµ– + ç”Ÿæˆ .env
	@echo "ğŸ‰ é¡¹ç›®åˆå§‹åŒ–å®Œæˆ"

## åˆ›å»ºè™šæ‹Ÿç¯å¢ƒï¼ˆuv ä¼šè‡ªåŠ¨å¤„ç† python ç‰ˆæœ¬ï¼‰
venv: ## åˆ›å»ºè™šæ‹Ÿç¯å¢ƒï¼ˆuv ä¼šè‡ªåŠ¨å¤„ç† python ç‰ˆæœ¬ï¼‰
	$(UV) venv $(VENV)

## å®‰è£…ä¾èµ–ï¼ˆpyproject.tomlï¼‰
install: ## å®‰è£…ä¾èµ–ï¼ˆpyproject.tomlï¼‰
	$(UV) sync

## ç”Ÿæˆ .envï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
env: ## ç”Ÿæˆ .envï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
ifneq ("$(wildcard .env)", "")
	@echo ".env å·²å­˜åœ¨ï¼Œè·³è¿‡"
else
	@echo "ç”Ÿæˆé»˜è®¤ .env æ–‡ä»¶"
	@echo "APP_ENV=dev" > .env
	@echo "DEBUG=true" >> .env
endif

## è¿è¡Œç¨‹åºï¼ˆæ ¹æ®ä½ çš„å…¥å£ä¿®æ”¹ï¼‰
run: ## æœ¬åœ°è¿è¡Œï¼ˆuvicorn çƒ­é‡è½½ï¼‰
	$(UV) run uvicorn src.main:app --reload --port 8000
	@echo="å¯åŠ¨ç”Ÿäº§æ¨¡å¼"

dev: ## fastapi devï¼ˆéœ€ uvï¼‰
	$(UV) run --project src fastapi dev src/main.py --port 8000
	@echo="webå¯åŠ¨å®Œæˆ"

## æ¸…ç†è™šæ‹Ÿç¯å¢ƒ
clean: ## æ¸…ç†è™šæ‹Ÿç¯å¢ƒä¸ç¼“å­˜
	rm -rf $(VENV)
	$(UV) cache clean
	ruff clean
	@echo "âš¡ï¸ è™šæ‹Ÿç¯å¢ƒå·²åˆ é™¤"

## æ ¼å¼åŒ–ä»£ç  (ä½¿ç”¨ ruff)
fmt: ## ä»£ç æ ¼å¼åŒ–ï¼ˆruffï¼‰
	$(UV) run ruff format .
	$(UV) run ruff check --fix .
	@echo="ğŸ’„ ä»£ç æ ¼å¼åŒ–å®Œæˆ"

## æ£€æŸ¥ä»£ç  (ä¸ä¿®æ”¹æ–‡ä»¶)
lint: ## ä»£ç æ£€æŸ¥ï¼ˆruffï¼‰
	$(UV) run ruff check .
	$(UV) run ruff format . --check
	@echo="âœ… ä»£ç é£æ ¼æ£€æŸ¥å®Œæˆ"

## é™æ€ç±»å‹æ£€æŸ¥ (ä½¿ç”¨ mypy)
mypy: ## é™æ€ç±»å‹æ£€æŸ¥ (mypy)
	$(UV) run mypy src
	@echo="âœ… é™æ€ç±»å‹æ£€æŸ¥å®Œæˆ"

all: fmt lint mypy ## æ‰§è¡Œæ‰€æœ‰æ£€æŸ¥ (æ ¼å¼åŒ–+é£æ ¼+ç±»å‹)
	@echo "âœ… æ‰€æœ‰æ£€æµ‹é€šè¿‡!"

## æµ‹è¯•
test: ## æµ‹è¯•
	$(UV) run pytest -q

# æ„å»ºç”Ÿäº§é•œåƒ
docker-build: ## docker build -t yamato-proxy .
	docker build -t yamato-proxy .

# å¯åŠ¨ï¼ˆç”Ÿäº§ï¼‰
docker-run: ## docker run -it --rm -p 8000:8000 --env-file .env yamato-proxy
	docker run -it --rm -p 8000:8000 --env-file .env yamato-proxy

# æŸ¥çœ‹æœ€æ–° yamato-proxy å®¹å™¨æ—¥å¿—ï¼ˆè·Ÿéšï¼‰
docker-logs: ## docker logs -f (åŸºäº yamato-proxy é•œåƒçš„æœ€æ–°å®¹å™¨)
	@cid=$$(docker ps --filter "ancestor=yamato-proxy" --format "{{.ID}}" | head -n1); \
	if [ -z "$$cid" ]; then \
		echo "æœªæ‰¾åˆ°è¿è¡Œä¸­çš„ yamato-proxy å®¹å™¨"; \
		exit 1; \
	fi; \
	echo "è·Ÿè¸ªå®¹å™¨ $$cid æ—¥å¿—..."; \
	docker logs -f $$cid

# ä½¿ç”¨ docker-composeï¼ˆå¼€å‘ + éƒ¨ç½²ï¼‰
compose-up: ## docker-compose up -d --build
	docker-compose up -d --build

compose-down: ## docker-compose down
	docker-compose down

deploy: compose-up ## æ„å»ºå¹¶å¯åŠ¨ï¼ˆcomposeï¼‰
	@echo "ğŸš€ Docker ç”Ÿäº§ç¯å¢ƒå·²å¯åŠ¨"
